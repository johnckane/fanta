---
title: "top40-models"
output: html_document
---

```{r}
library(tidyverse)
load("/home/john/projects/fantasy-football/data/analysis-data/wr.Rda")
```

```{r}
head(wr)
```

```{r}
min(wr$experience)
```

```{r}
wr %>%
  filter(experience == 0) %>%
  mutate(top40 = ifelse(league_rank <= 40,1,0)) %>%
  group_by(year) %>%
  summarise(count = n(),
            sum = sum(top40),
            ttl = sum(top40)/n())
```

```{r}
wr %>%
  filter(league_rank <= 40, year > 2010) %>%
  mutate(group = case_when(between(league_rank,1,5) ~ 1,
                           between(league_rank,6,10) ~ 1.5,
                           between(league_rank,11,20) ~ 2,
                           between(league_rank,21,30) ~ 3,
                           between(league_rank,31,40) ~ 4,
                           TRUE ~ NA_real_)) %>%
  ggplot(data = .,
         aes(x = league_rank,
             y = total_points)) +
  geom_point(alpha = 0.1) +
  geom_smooth() +
  geom_smooth(aes(colour = as.factor(group), group = group),method = "lm") +
  geom_smooth(method = 'lm')
```

```{r}
wr %>%
  filter(league_rank <= 45) %>%
  mutate(group = case_when(between(league_rank,1,5) ~ 1,
                           between(league_rank,6,15) ~ 2,
                           between(league_rank,16,25) ~ 3,
                           between(league_rank,26,35) ~ 4,
                           between(league_rank,36,45) ~ 5,
                           TRUE ~ NA_real_)) %>%
  group_by(group) %>%
  summarise(mean_points = mean(total_points))
```

```{r}
wr %>%
  filter(league_rank <= 40) %>%
  mutate(group = case_when(between(league_rank,1,5) ~ 1,
                           between(league_rank,6,10) ~ 2,
                           between(league_rank,11,20) ~ 3,
                           between(league_rank,21,30) ~ 4,
                           between(league_rank,31,40) ~ 5,
                           TRUE ~ NA_real_)) %>%
  group_by(group) %>%
  summarise(mean_points = mean(total_points))
```

```{r}
wr %>%
  filter(league_rank <= 40) %>%
  mutate(group = case_when(between(league_rank,1,8) ~ 1,
                           between(league_rank,9,16) ~ 2,
                           between(league_rank,17,24) ~ 3,
                           between(league_rank,25,32) ~ 4,
                           between(league_rank,33,40) ~ 5,
                           TRUE ~ NA_real_)) %>%
  group_by(group) %>%
  summarise(mean_points = mean(total_points)) %>%
  mutate(ppg = mean_points/16)
```



```{r}
wr %>%
  filter(league_rank <= 40) %>%
  mutate(era = ifelse(year >= 2015,1,0)) %>%
  ggplot(data = .,
         aes(x = league_rank,
             y = total_points,
             group=era,
             colour = as.factor(era))) +
  geom_point(alpha = 0.1) +
  geom_smooth() +
  geom_smooth(aes(colour = as.factor(era), group = era),method = "lm") +
  geom_smooth(method = 'lm')
```

```{r}
wr %>%
  filter(league_rank <= 40) %>%
  group_by(year) %>%
  summarise(mean_top40_points = mean(total_points)) %>%
  ggplot(data = .,
         aes(x = year,
             y = mean_top40_points)) +
  geom_bar(stat = 'identity')
```

Model baseline:




```{r}
yoy_top <- 
wr %>%
  filter(is.na(league_rank) == FALSE) %>%
  mutate(top40 = ifelse(league_rank <= 40,1,0),
         top20 = ifelse(league_rank <= 20,1,0),
         top10 = ifelse(league_rank <= 10,1,0),
         top5  = ifelse(league_rank <= 5,1,0)) %>%
  arrange(player,year) %>%
  group_by(player) %>%
  mutate(top40_lastyear = ifelse(lag(year) == year - 1, lag(top40),NA),
         top20_lastyear = ifelse(lag(year) == year - 1, lag(top20),NA),
         top10_lastyear = ifelse(lag(year) == year - 1, lag(top10),NA),
         top5_lastyear  = ifelse(lag(year) == year - 1, lag(top5),NA),
         team_rank_lastyear = ifelse(lag(year) == year - 1,lag(team_rank),NA),
         league_rank_lastyear = ifelse(lag(year) == year - 1,lag(league_rank),NA))
```

```{r}
yoy_top %>%
  filter(top40 == 1) %>%
  group_by(year) %>%
  summarise(total_players = sum(top40),
            carryover40 = sum(top40_lastyear, na.rm = T),
            carryover20 = sum(top20_lastyear, na.rm = T),
            carryover10 = sum(top10_lastyear, na.rm = T),
            carryover5  = sum(top5_lastyear, na.rm = T)) %>%
  ungroup() %>%
  summarise(mean40 = mean(carryover40)/40,
            mean20 = mean(carryover20)/20,
            mean10 = mean(carryover10)/10,
            mean5 = mean(carryover5)/5)
```


```{r}
yoy_top <- 
wr %>%
  filter(is.na(league_rank) == FALSE) %>%
  mutate(top40 = ifelse(league_rank <= 40,1,0),
         top20 = ifelse(league_rank <= 20,1,0),
         top10 = ifelse(league_rank <= 10,1,0),
         top5  = ifelse(league_rank <= 5,1,0)) %>%
  arrange(player,year) %>%
  group_by(player) %>%
  mutate(top40_lastyear = ifelse(lag(year) == year - 1, lag(top40),NA),
         top20_lastyear = ifelse(lag(year) == year - 1, lag(top20),NA),
         top10_lastyear = ifelse(lag(year) == year - 1, lag(top10),NA),
         top5_lastyear  = ifelse(lag(year) == year - 1, lag(top5),NA),
         team_rank_lastyear = ifelse(lag(year) == year - 1,lag(team_rank),NA),
         league_rank_lastyear = ifelse(lag(year) == year - 1,lag(league_rank),NA))

yoy_top %>%
  filter(top40 == 1) %>%
  group_by(year) %>%
  summarise(total_players = sum(top20),
            carryover = sum(top20_lastyear, na.rm = T))
```



## Benchmarks
1) top 40 YOY will make it the next year
2) 4 top 5, then 3 of the remaining top 10, then 3 of the remaining top 20, then 9 of the remaining top 40. 
3) 

```{r}
colnames(yoy_top)
```

```{r}

yoy_top %>%
  ungroup() %>%
  filter(is.na(top40_lastyear) == F) %>%
  split(.$year) %>% # from base R
    map(~with(.,pROC::auc(predictior = top40_lastyear, response = top40))) 
  
with(yoy_top,pROC::auc(predictor=top40_lastyear, response = top40))


map(~ lm(top40 ~ top40_lastyear, data = .)) #%>%


split_list <- yoy_top %>% ungroup() %>% split(.$year)

output <- sapply(X = split_list, FUN = function(x) pROC::auc(predictor = x$top40_lastyear, response = x$top40))

output <- sapply(X = split_list, FUN = function(x) sum(x$top40_lastyear + x$top40,na.rm = T))

output <- sapply(X = split_list, FUN = function(x) with(x, pROC::auc(predictor = top40_lastyear, response = top40)))

output


?purrr::map


d07 <- yoy_top %>% filter(year == 2007)

pROC::auc(response = d07$top40, predictor = d07$top40_lastyear)

#pROC::auc(yoy_top$top40,yoy_top$top40_lastyear)
```






